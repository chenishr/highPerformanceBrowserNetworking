##	初识延迟与带宽

###	速度就是特性

近几年来，网络性能优化（WPO）的出现与快速发展，已经成为用户追求更快速度、更好体验的一个重要标记。这不仅是这个加速连接的现实中对速度的情感需求，更是由在线商务对性能底线衡量结果的需求：

*	更快的网站能让用户更好地参与其中。

*	更快的网站能有更高的回头率。

*	更快的网站能有更高的转换率。

简而言之，速度即特性。而要更快速，我们需要理解在起作用的许多因素和基本限制。本章，我们将会专注于两个决定所有网络性能的要素：延迟和带宽。

延迟
>	从源发送一个数据包到目的的时间。

带宽
>	逻辑或物理通讯的最大吞吐量。

![figure1-1][figurel11]

######	图 1-1、延迟与带宽

为了更好地了解延迟与带宽一起是如何工作的，我们会使用工具来进一步了解 TCP、UDP和所有基于它们的协议的内部构件和性能特性。

>	<h5>低时延的跨大西洋高速光缆工程</h5>

>	在高频交易的金融市场中，延迟是一个重要的标准，一个很少的差别或毫秒级的延迟也会导致巨大的损失。

>	在 2011 年初，华为和爱尔兰部署一条全新的横跨大西洋的光纤电缆，连接伦敦和纽约。其目标是，与其他现存的线路相比，以更短的路由为交易员节省 5 毫秒的延迟。

>	一旦完成部署，它只会被适用于金融行业。该光纤将会耗资4亿美元，一毫秒的代价是80001万美元。延迟的代价是昂贵的，超出想象。

###	影响延迟的因素

延迟是一个消息或者说数据包从源被传送到目的所用的时间。这是一个简单而实用的定义，但却隐藏的大部分有用的信息：一个系统通常包含许多的源或者组件，每发送一个消息，它们都会耗费一定的时间。了解有那些组件和那些决定着性能很重要。

让我们来分析以下，在一个网络典型的路由中，有那些常规的组件，而那些是对性能起着决定性作用的：

*	传播时延
>	一个数据包在从发送方到接收方所需的时间，这是一个距离除以信号传输速度的函数。

*	发送时延
>	将数据包全部发送到链路的时间，这是一个数据包长度除以发送速率的函数。

*	处理时延
>	节点处理数据包头所需要的时间，例如检查位错误、确定数据包的目的地。

*	排队时延
>	数据包在输入队列中等待处理的时间。

在客户端到服务器之间的总时延就是以上所列时延的总和。传播时延是由传播的距离和信号传输的媒介来决定的。正如我们所知道的那样，传播速度通常是一个很小的光速常量因子。然而，发送时延则是由发送速率决定的，和传播的距离没有关系。举个例子，假设我们要通过两个链路发送一个 10Mb 的文件：一个链路的发送速率是 1Mbps，另一个的是 100Mbps。在前一个链路中，将文件全部发送到链路上需要 10 秒钟，而在后一个链路中只需要 0.1 秒。

接着，数据包到达路由器时，路由器会检查数据包头来决定下一个路由，也会进行其它的检查——这些都是会消耗时间的。大部分的这些逻辑都已经固化到硬件上了，所以时延会很小，但它还是存在的。最后，如果数据包到达速度大于路由器的处理速度，那么数据包就会排队到一个输入缓存中。数据包在缓存中所消耗的时间，毫无疑问，正是传说中的排队时延。

数据包在网络上传播时会触发很多次这些时延。两个端点之间的距离越远，传播时延就会越长。在传播中经过越多的路由器，每个数据包所需要的处理时延和发送时延就会越多。最后，链路上的流量越高，数据包在输入缓存中的排队时延就越长。

>	<h5>本地路由的缓存臃肿</h5>

>	缓存臃肿是一个由 Jim Gettys 在 2010 年创建和普及的术语，这是一个描述排队时延对网络性能的影响的很好的例子。

>	现在的问题是，许多路由器为了避免网络丢包而配置了大量的接收缓存。然而，这样做会破坏了 TCP 拥塞避免机制（这将会在下一章讲述），并且引入了高可变的网络延迟。

>	好消息是，新的 CoDel 主动队列管理算法可以解决这个问题，该算法已经在 3.5+ 的 Linux 内核中实现了。要了解更多，情参考 ACM 队列的“[控制队列时延][aqmacm]”。

###	光速与传播延迟

正如爱因斯坦的狭义相对论所描述的那样，光速是所有的能量、物质和信息所能达到的最大速度。这是一个所有网络数据包传播时间的很明显的限制。

光速很快，高达 299,792,458 米每秒，或者说是 186,282 英里每秒，这是好消息。然而，凡事总有然而，那是光线在真空中的速度。我们的数据包是通过媒介来传播的，如同轴电缆或者光纤，这会降低信号的速度（表1-1）。光波的速度与数据包在媒介的速度之比就是该媒介的折射率。折射率越大，光波的传播速度越小。

数据包长途传播所使用的光纤，其典型的折射率的值会在 1.4 到 1.6 之间。人们正在一步一步地改善传播媒介的质量和降低其折射率。但为了简单起见，经验法则是假设光波在光纤的传播速度为 200,000,000 米每秒，相应的折射率约为 1.5 。所幸者，我们已经可以达到这样的一个高速了。感谢那些伟大的工程师。

表1-1 信号分别在真空和光纤中的延迟
<table>
	<tr>
		<th>路由</th>
		<th>距离</th>
		<th>真空中的延迟</th>
		<th>光纤中的延迟</th>
		<th>光纤中的往返时间（RTT）</th>
	</tr>
	<tr>
		<td>纽约到旧金山</td>
		<td>4,148 km</td>
		<td>14 ms</td>
		<td>21 ms</td>
		<td>42 ms</td>
	</tr>
	<tr>
		<td>纽约到伦敦</td>
		<td>5,585 km</td>
		<td>19 ms</td>
		<td>28 ms</td>
		<td>56 ms</td>
	</tr>
	<tr>
		<td>纽约到悉尼</td>
		<td>15,993 km</td>
		<td>53 ms</td>
		<td>80 ms</td>
		<td>160 ms</td>
	</tr>
	<tr>
		<td>赤道周长</td>
		<td>40,075 km</td>
		<td>133.7 ms</td>
		<td>200 ms</td>
		<td>200 ms</td>
	</tr>
</table>






[aqmacm]:	http://hpbn.co/aqmacm
[figurel11]:	images/ch01/hpbn_0101.png	"Latency and Bandwidh"
