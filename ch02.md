##	第二章、构建 TCP 块

互联网的两个核心协议是 IP 和 TCP 协议。IP，即网际协议，提供主机到主机之间的路由和寻址功能；TCP，即传输控制协议，主要是在不可靠的通道中提供可靠的网络传输。TCP/IP 也通常被成为网络协议套件，它是 Vint Cerf 和 Bob Kahn 1974 年在他们的论文“网络通讯协议包”中首次被提出来的。

最初的提议（RFT 675）已经被修改过好几次了，到 1981 年的 V4 版的规格被拆分成两个 RFC：

*	RFC 791	——	网际协议

*	RFC 793	——	传输控制协议

从那以后，TCP 有许多许多改进的建议，但其核心操作却没有明显的改变。TCP 迅速替换掉的其它协议，现在成为许多流行应用的协议，如万维网，电子邮件，文件传输等等。

TCP 在一个不可靠的通道上有效地抽象了一个可靠的网络，为我们的应用隐藏的许多复杂的网络通讯：丢失重传，顺序到达，拥塞的控制与避免，数据的完整性等等。当你使用 TCP 流时，你会得到保证，所发送的每一个字节都会被接收到，并且它们会按顺序的到达客户端。因此，TCP 是优化了准确的交付，但并不是及时的。结果是，当在浏览器中进行网络性能优化时会有不少挑战。

HTTP 标准并没有指定 TCP 作为唯一的传输协议。如果你想要，你可以使用 UDP （用户数据包协议）或者任何其它传输协议来传输 HTTP 。但实际上，今天互联网上所有的 HTTP 流量都是通过 TCP 来传输的，因为它有许多很棒的特性。

正因如此，了解一些 TCP 的核心机制是搭建一个体验好的网站的重要知识。你不用在你的应用中直接和 TCP 打交道，但是你在应用层面所做的选择会决定 TCP 的性能和应用底层的交互。

>	<h5>IP 和 TCP 协议相互交织的历史</h5>

>	我们的知道 IPv4 和 IPv6，但是那些 IPv{1,2,3,5} 呢？4 在 IPv4 中代表的是 TCP/IP 的第四个版本，它是在 1981 年发布的。原始的 TCP/IP 提案是这两个协议的集合，到第四版本草案中正式将其拆分成两个 RFC 。因此，IPv4 中的 v4 和 TCP 并没有继承关系，它独立于 IPv1，IPv2，IPv3 协议。

>	在 1994 年，当工作组开始进行“下一代网际协议”的工作时，需要一个新的版本号，但是 v5 已经分配给了一个实验性的协议：网络流协议（ST）。结果是，ST 从没有使用过，这就是为什么很少听到它。因此，这就有了 IPv6 。

###	三次握手

所有的 TCP 链接都是以三次握手（图 2-1）开始的。在客户端或者服务器能够交换任何数据之前，通信双方必须对开始同步数据包序号以及一些其它的连接变量进行确认。出于安全的考虑，同步序号由双方随记产生。

>	<h5>SYN</h5>

>	客户端随记选择一个同步序号 x 来发送一个 SYN 数据包，这可以携带额外的 TCP 标识和选项。

>	<h5>SYN ACK</h5>

>	服务器将 x 增加 1 ，在随机产生一个同步序号 y ，加上它的标示和选项，向客户端发送响应。

>	<h5>ACK</h5>

>	客户端将 x 和 y 分别增加 1 ，然后想服务器发送 ACK 数据包来完成三次握手。

![figure 2-1][figure21]

######	图 2-1	三次握手

一旦三次握手完成以后，应用数据就可以在客户端和服务器之间传输了。客户端在发送完 ACK 之后就可以马上数据了，但服务器必须在收到 ACK 之后才能发送数据。每个 TCP 连接都必须经过这个启动过程，对于所有使用 TCP 的网络应用程序来说，这包含了一个非常重要的优化暗示：每个连接在发送任何应用数据之前，都必须消耗一个完整的往返延迟。

例如，假设我们的客户端在纽约，服务器在伦敦，我们通过光纤来启动一个新的 TCP 连接，那么三次握手至少消耗掉 56 毫秒的时间（表 1-1）：数据包单向的传输时间是 28 毫秒，之后在返回纽约。要注意到，带宽在这里不起任何作用。相反，这里的时延是在客户端与服务器之间的延迟造成的，也就是纽约到伦敦的传播时延。

进行三次握手所带来的延迟使创建新的 TCP 链接显得相当昂贵，这也是为什么连接重用是那些基于 TCP 的应用的一个重要的优化方案。

>	<h5>快速打开 TCP</h5>

>	TCP 握手已经成为浏览器总延迟中的一个重要的根源，很大程度上是因为数十到数百的不同服务器请求很短的 TCP 流。

>	快速打开 TCP （TFO）是一个旨在减少由于创建新 TCP 连接而引入的延迟的机制。根据谷歌完成的流量分析和网络仿真，研究人员展示了 TFO （它允许在 SYN 包中传输数据）可以减少 15% 的 HTTP 网络传输延迟，平均减少超过 10% 的整页加载时间，在某些情况下减少高达 40% 的高延迟场景。

>	在 3.7+ 的 Linux 内核中同时支持客户端和服务器端 TFO ，这样会给新的客户端和服务器提供很多选项。话虽如此，TFO 并非所有问题的解决方案。虽然它可以消除三次握手所带来的延迟，但这也是在特定的情况下才起作用：









[figure21]:	images/ch02/hpbn_0201.png	"三次握手"
